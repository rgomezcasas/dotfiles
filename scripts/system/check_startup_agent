#!/usr/bin/env bash

##? Check and restart startup LaunchAgent if needed
##?
##? Usage:
##?   check_startup_agent

set -euo pipefail

source "$DOTLY_PATH/scripts/core/log.sh"

AGENT_LABEL="com.user.startup"
PLIST_PATH="$HOME/Library/LaunchAgents/${AGENT_LABEL}.plist"

main() {
    if ! launchctl list "$AGENT_LABEL" >/dev/null 2>&1; then
        log::warning "LaunchAgent $AGENT_LABEL is not running. Reloading..."

        if [[ -f "$PLIST_PATH" ]]; then
            launchctl load "$PLIST_PATH" 2>/dev/null || {
                log::error "Failed to load LaunchAgent"
                exit 1
            }

            log::success "LaunchAgent reloaded successfully"
        else
            log::error "Plist file not found: $PLIST_PATH"

            exit 1
        fi
    else
        log::success "LaunchAgent $AGENT_LABEL is running"
    fi
}

main "$@"